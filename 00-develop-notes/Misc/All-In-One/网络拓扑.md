---
title: 网络拓扑
created: 2024-06-16
tags:
    - All-In-One
    - Network
    - Homelab
---

# 网络拓扑

## 家庭网络拓扑

家用路由器的 LAN 口可以被认为是一个交换机，该交换机与路由器 WAN 口相连，这个 WAN 口的 IP 地址即路由器的 IP 地址。路由器的 DHCP 服务将为所有连接到 LAN 口的设备分配 IP 地址、网关等信息。

![](Pasted%20image%2020240616235513.png)

## 旁路网关

旁路网关模式通常涉及多个网络设备，以确保网络流量根据需要路由。以下是一个简单的旁路网关模式拓扑图的文字描述：

```
[Internet]
    |
[Modem]
    |
[Wireless Router] -- (Direct Traffic) --> [External Network]
    |
[Soft Router] (Configured as Gateway)
    |
[Devices using Soft Router as Gateway]
```

在这个拓扑结构中：
1. **Modem**：连接到互联网，并提供网络连接给无线路由器。
2. **Wireless Router**：接收来自调制解调器的网络连接，并提供无线网络连接给其他设备。它的IP地址可以作为一些设备的网关。
3. **Soft Router**：配置为旁路网关模式，连接在无线路由器与使用它作为网关的设备之间。
4. **Devices**：一些设备使用无线路由器的IP地址作为网关，这些设备的流量会直接通过无线路由器发送到外网，不经过软路由。另一些设备使用软路由的IP地址作为网关，它们的流量会通过软路由进行处理。

你可以用下图更直观地理解这个拓扑结构：

```
        [ Internet ]
             |
          [ Modem ]
             |
       [ Wireless Router ]
        /           \
    (Direct)        [ Soft Router ]
    /                   \
[ Devices ]          [ Devices using Soft Router as Gateway ]
(using Wireless
Router as Gateway)
```

在此拓扑结构中：
- 连接到无线路由器的设备将直接访问外网，流量不经过软路由。
- 通过软路由作为网关的设备，其流量将会经过软路由的处理，然后再访问外网。

![Bypass-Gateway-Mode-Topology.excalidraw](Bypass-Gateway-Mode-Topology.excalidraw.md)

如上图为旁路网关的一种配置方式，将主路由的 DHCP 服务关闭，启用旁路网关的 DHCP。因为主路由的 DHCP 服务可能无法单独配置每个设备的 Gateway 和 DNS，无法控制单个设备的是否经过软路由代理。而 OpenWRT 默认使用 DNSMASQ 提供 DHCP 和 DNS 服务，支持为不同设备分配不同网关。

**Caution**: 在启用软路由的 DHCP 之后，所有先前通过主路由 DHCP 分配网络信息的设备需要重新介入网络以更新通过软路由 DHCP 下发的新的网络配置（Gateway / DNS）。

旁路由的非对称路由问题通常涉及数据包的路径不一致，导致网络流量的返回路径与发送路径不同。这种非对称路由问题可能会引发一系列问题，具体如下：

### 旁路由对不同网络设备的 DHCP 服务配置

![[OpenWRT 通过配置 DHCP 服务为不同设备分配不同的 Gateway 和 DNS IP#OpenWRT 通过配置 DHCP 服务为不同设备分配不同的 Gateway 和 DNS IP]]

### 非对称路由

在访问无需经过代理的网站时，由于被访问的网站 IP 地址不是内网网段，数据包将被转发到配置的内网网关，即软路由。软路由中的代理服务判断该域名或 IP 无需经过代理，于是将数据包转发至主路由并进行 NAT 转换，最终发送至公网。而在响应数据包返回时，由于源 IP 和主路由位于同一网段，所以包将直接转发至网络设备。此时便出现了非对称路由的问题。

![Asymmetric-Routing-Request.excalidraw](Asymmetric-Routing-Request.excalidraw.md)

[Asymmetric-Routing-Response.excalidraw](Asymmetric-Routing-Response.excalidraw.md)

发送与接收的路由不一致，由于软路由没有收到 TCP 三次握手中的 SYN-ACK 报文，所以在软路由防火墙打开丢弃无效包的情况下，客户端发送的第三次握手的 ACK 报文会被视为无效数据包，从而导致 TCP 链接无法建立。

#### 非对称路由问题的主要表现
1. **数据包丢失：** 非对称路由可能导致数据包丢失，因为返回路径不同可能经过不同的网络设备和防火墙规则，导致包被丢弃。
2. **延迟和抖动增加：** 不同路径的延迟和抖动可能不同，导致整体网络性能不稳定。
3. **会话中断：** 对于状态检测防火墙或会话依赖的应用，非对称路由可能导致会话中断，因为会话信息不完整。
4. **安全漏洞：** 非对称路由可能绕过某些安全检查和监控措施，使得网络更容易受到攻击。

#### 解决非对称路由问题的建议
1. **网络拓扑规划：** 设计合理的网络拓扑结构，确保入口和出口路径一致，避免流量绕行。
2. **路由策略控制：** 使用路由策略和协议（如BGP、OSPF）来控制数据包路径，确保对称路由。
3. **会话保持：** 配置防火墙和负载均衡设备以保持会话状态，确保数据包的进出路径一致。
4. **日志和监控：** 实时监控和日志分析，及时发现并解决非对称路由问题。
5. **设备配置优化：** 确保路由设备的配置正确，避免由于配置错误引发的非对称路由。

通过以上措施，可以有效解决和缓解旁路由引发的非对称路由问题，确保网络流量的稳定和安全。

#### OpenWRT 中的解决方案

打开 LAN -> WAN 的 `IP 动态伪装`，软路由在转发数据包至主路由时，将进行一次 NAT 转换。该解决方法会引入一次额外的 NAT 转换，对网络性能可能造成影响。

## Reference

[【家庭分流】最详细旁路由配置指南，什么是旁路由？旁路由解决了什么问题？又带来了什么问题？为什么旁路由存在争议？旁路网关、透明网关、透明代理、网关模式、网关代理和旁路由的关系，人人都能学会旁路由入门配置](https://www.youtube.com/watch?v=cFOob3djiOA)
